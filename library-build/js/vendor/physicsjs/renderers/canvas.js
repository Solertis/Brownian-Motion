/**
 * PhysicsJS v1.0.0-rc1 - 2014-04-13
 * A modular, extendable, and easy-to-use physics engine for javascript
 * http://wellcaffeinated.net/PhysicsJS
 *
 * Copyright (c) 2014 Jasper Palfree <jasper@wellcaffeinated.net>
 * Licensed MIT
 */

(function(e,t){typeof define=="function"&&define.amd?define(["physicsjs"],t):typeof exports=="object"?module.exports=t.apply(e,["physicsjs"].map(require)):t.call(e,e.Physics)})(this,function(e){return e.renderer("canvas",function(t){if(!document)return{};var n=Math.PI*2,r=function(e,t){var n=document.createElement(e||"div");return t&&(n.innerHTML=t),n},i={white:"#fff",violet:"#542437",blue:"#53777A"},s={debug:!1,metaEl:null,styles:{circle:{strokeStyle:i.blue,lineWidth:1,fillStyle:i.blue,angleIndicator:i.white},"convex-polygon":{strokeStyle:i.violet,lineWidth:1,fillStyle:i.violet,angleIndicator:i.white}},offset:{x:0,y:0}},o=function(t,n){return e.util.isPlainObject(n)?e.util.extend({},t,n,o):n!==undefined?n:t};return{init:function(n){var i=this;t.init.call(this,n),this.options=e.util.extend({},s,this.options,o),this.options.offset=e.vector(this.options.offset),this.hiddenCanvas=document.createElement("canvas"),this.hiddenCanvas.width=this.hiddenCanvas.height=100;if(!this.hiddenCanvas.getContext)throw"Canvas not supported";this.hiddenCtx=this.hiddenCanvas.getContext("2d");var u=this.el;u.nodeName.toUpperCase()!=="CANVAS"&&(u=document.createElement("canvas"),this.el.appendChild(u),typeof this.options.el=="string"&&this.el===document.body&&(u.id=this.options.el),this.el=u),this.ctx=u.getContext("2d"),this.els={};if(this.options.meta){var a=this.options.metaEl||r();a.className="pjs-meta",this.els.fps=r("span"),this.els.ipf=r("span"),a.appendChild(r("span","fps: ")),a.appendChild(this.els.fps),a.appendChild(r("br")),a.appendChild(r("span","ipf: ")),a.appendChild(this.els.ipf),u.parentNode.insertBefore(a,u)}this._layers={},this.addLayer("main",this.el),this.resize(this.options.width,this.options.height)},layer:function(e){return e in this._layers?this._layers[e]:null},addLayer:function(t,n,r){var i=this,s=[],o=e.util.extend({},this.options.styles),u={id:t,el:n||document.createElement("canvas"),options:e.util.options({width:this.el.width,height:this.el.height,manual:!1,autoResize:!0,follow:null,offset:null,scale:1,zIndex:1})(r)};if(t in this._layers)throw'Layer "'+t+'" already added.';return this.el.parentNode.insertBefore(u.el,this.el),u.el.style.position="absolute",u.el.style.zIndex=u.options.zIndex,u.el.className+=" pjs-layer-"+u.id,u.ctx=u.el.getContext("2d"),u.ctx.scale(1,1),u.el.width=u.options.width,u.el.height=u.options.height,u.bodies=s,u.reset=function(e){return s=e||[],u},u.addToStack=function(t){return e.util.isArray(t)?s.push.apply(s,t):s.push(t),u},u.removeFromStack=function(t){var n,r;if(e.util.isArray(t))for(n=0,r=t.length;n<r;++n)u.removeFromStack(t[n]);else n=e.util.indexOf(s,t),n>-1&&s.splice(n,1);return u},u.render=function(t){var n,r=e.scratchpad(),a=r.vector().set(0,0),f=u.options.scale,l,c,h=s.length,p=h||u.id!=="main"?s:i._world._bodies;if(u.options.manual)return r.done(),u;u.options.offset&&(u.options.offset==="center"?a.add(u.el.width*.5,u.el.height*.5).mult(1/f):a.vadd(u.options.offset).mult(1/f)),u.options.follow&&a.vsub(u.options.follow.state.pos),t!==!1&&u.ctx.clearRect(0,0,u.el.width,u.el.height),f!==1&&(u.ctx.save(),u.ctx.scale(f,f));for(c=0,h=p.length;c<h;++c)n=p[c],n.hidden||(l=n.view||(n.view=i.createView(n.geometry,n.styles||o[n.geometry.name])),i.drawBody(n,n.view,u.ctx,a));return f!==1&&u.ctx.restore(),r.done(),u},this._layers[t]=u,u},removeLayer:function(e){var t=e.id?e.id:e,n=this._layers[t].el;return n!==this.el&&n.parentNode.removeChild(n),delete this._layers[t],this},resize:function(e,t){var n;for(var r in this._layers)n=this._layers[r],n.options.autoResize&&(n.el.width=e,n.el.height=t);return this},setStyle:function(t,n){n=n||this.ctx,e.util.isObject(t)?(t.strokeStyle=t.lineWidth?t.strokeStyle:"rgba(0,0,0,0)",e.util.extend(n,t)):(n.fillStyle=n.strokeStyle=t,n.lineWidth=1)},drawCircle:function(e,t,r,i,s){s=s||this.ctx,s.beginPath(),this.setStyle(i,s),s.arc(e,t,r,0,n,!1),s.closePath(),s.stroke(),s.fill()},drawPolygon:function(e,t,n){var r=e[0],i=r.x,s=r.y,o=e.length;n=n||this.ctx,n.beginPath(),this.setStyle(t,n),n.moveTo(i,s);for(var u=1;u<o;++u)r=e[u],i=r.x,s=r.y,n.lineTo(i,s);o>2&&n.closePath(),n.stroke(),n.fill()},drawRect:function(e,t,n,r,i,s){var o=n*.5,u=r*.5;s=s||this.ctx,this.setStyle(i,s),s.beginPath(),s.rect(e-o,t-u,n,r),s.closePath(),s.stroke(),s.fill()},drawLine:function(e,t,n,r){var i=e.x,s=e.y;r=r||this.ctx,r.beginPath(),this.setStyle(n,r),r.moveTo(i,s),i=t.x,s=t.y,r.lineTo(i,s),r.stroke(),r.fill()},createView:function(e,t){var n,r=e.aabb(),i=r.hw+Math.abs(r.x),s=r.hh+Math.abs(r.y),o=i+1,u=s+1,a=this.hiddenCtx,f=this.hiddenCanvas,l=e.name;return t=t||this.options.styles[l]||{},t.src?(n=new Image,n.src=t.src,t.width&&(n.width=t.width),t.height&&(n.height=t.height),n):(o+=t.lineWidth|0,u+=t.lineWidth|0,f.width=2*i+2+(2*t.lineWidth|0),f.height=2*s+2+(2*t.lineWidth|0),a.save(),a.translate(o,u),l==="circle"?this.drawCircle(0,0,e.radius,t,a):l==="convex-polygon"&&this.drawPolygon(e.vertices,t,a),t.angleIndicator&&(a.beginPath(),this.setStyle(t.angleIndicator,a),a.moveTo(0,0),a.lineTo(i,0),a.closePath(),a.stroke()),a.restore(),n=new Image(f.width,f.height),n.src=f.toDataURL("image/png"),n)},drawMeta:function(e){this.els.fps.innerHTML=e.fps.toFixed(2),this.els.ipf.innerHTML=e.ipf},drawBody:function(e,t,n,r){var i=e.state.pos,s;r=r||this.options.offset,n=n||this.ctx,n.save(),n.translate(i.x+r.x,i.y+r.y),n.rotate(e.state.angular.pos),n.drawImage(t,-t.width/2,-t.height/2),n.restore(),this.options.debug&&(s=e.aabb(),this.drawRect(s.x,s.y,2*s.hw,2*s.hh,"rgba(0, 0, 255, 0.3)"),e._debugView=e._debugView||this.createView(e.geometry,"rgba(255, 0, 0, 0.5)"),n.save(),n.translate(i.x+r.x,i.y+r.y),n.rotate(e.state.angular.pos),n.drawImage(e._debugView,-e._debugView.width*.5,-e._debugView.height*.5),n.restore())},render:function(e,t){var n,r,i;this._world.emit("beforeRender",{renderer:this,meta:t}),this.options.meta&&this.drawMeta(t);for(var s in this._layers)this._layers[s].render();return this}}}),e});